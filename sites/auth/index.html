<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/logo-orange.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auth</title>
  </head>
  <body>
    <script>
      const GOOGLE_CLIENT_ID = '603559646501-i29ma3u7c590ijimgp809vpdhg52jibd.apps.googleusercontent.com'
      const GOOGLE_OAUTH2_URL = 'https://accounts.google.com/o/oauth2/auth'

      const MICROSOFT_CLIENT_ID = 'c44ceeca-8f9a-49c2-9bea-cc7135da8943'
      const MICROSOFT_OAUTH2_URL = 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize'

      const CLASSLINK_CLIENT_ID = 'c17067461192207630e7cc2ae2d82cccf1f28f20bd10'
      const CLASSLINK_OAUTH2_URL = 'https://launchpad.classlink.com/oauth2/v2/auth'

      const CORE_AUTH_SERVICE_PUBLIC_KEY = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA59Uz6jvBJF3B8/7xMqGo
XkIhLFvTCHuFIGuCNNZGCJUnSk2ne6Jp1ehUIarliJwzrvfr2HMe0PvzAJyZqQIs
uz0Lt867TTojCAKJunxbcrwEhzvz0FNjNu1wpgkSHFvd1uTvRSZqauqUmG0HqC17
HSmBaXivB49B/pviowVJc+mUJJ9MROtOiL4JN5niHnLbt6QVi6NITAJkOwtoRhck
5j0KLvfrq18R8QrfDOq3v5hWlrA6j1wPvTW1mzFk8MrOZw935mMDdMivFAm/DltM
NT5I3YnLZpcl1e/fydC+B6zSz2nZfLb2iDBbADDVj2+i9JUEFomg6ng1DjHUGMYc
ZQIDAQAB
-----END PUBLIC KEY-----
`

      if (window.location.pathname !== '/') {
        const [_, provider, state] = window.location.pathname.split('/')
        const info = { origin: document.referrer, provider }
        localStorage.setItem(state, JSON.stringify(info))

        const query = {
          redirect_uri: window.location.origin + '/',
          response_type: 'code',
          nonce: Math.random().toString(36).substring(2),
          state
        }

        let url

        if (provider === 'google') {
          query.client_id = GOOGLE_CLIENT_ID
          query.prompt = 'select_account'
          query.scope = 'openid profile'
          url = GOOGLE_OAUTH2_URL
        }
        else if (provider === 'microsoft') {
          query.client_id = MICROSOFT_CLIENT_ID
          query.prompt = 'select_account'
          query.scope = 'openid profile'
          url = MICROSOFT_OAUTH2_URL
        }
        else if (provider === 'classlink') {
          query.client_id = CLASSLINK_CLIENT_ID
          query.prompt = 'select_account'
          query.scope = 'profile'
          url = CLASSLINK_OAUTH2_URL
        }

        window.location.href = `${url}?${objectToQuerystring(query)}`
      }
      else {
        const { state, code } = Object.fromEntries(new URLSearchParams(window.location.search).entries())

        if (code && state) {
          const { origin, provider } = JSON.parse(localStorage.getItem(state))
          localStorage.removeItem(state)

          const { protocol, host } = new URL(origin)

          const tokenContents = { code, provider, domain: host }
          encryptString(CORE_AUTH_SERVICE_PUBLIC_KEY, JSON.stringify(tokenContents))
            .then(encryptedToken => window.location.href = `${protocol}//${host}/auth/${state}/${encryptedToken}`)
            .catch(error => console.warn(error))
        }
      }

      function parseHash(hash) {
        const params = hash.substr(1).split('&')
        const result = {}
        params.forEach(param => {
          const parts = param.split('=')
          result[parts[0]] = parts[1]
        })
        return result
      }

      function objectToQuerystring(o) {
        return Object.entries(o).map(([k,v]) => `${k}=${encodeURIComponent(v)}`).join('&')
      }

      async function encryptString(publicKeyPem, plainText) {
        const publicKey = await crypto.subtle.importKey(
          'spki',
          pemToArrayBuffer(publicKeyPem),
          { name: 'RSA-OAEP', hash: 'SHA-256' },
          true,
          ['encrypt']
        )

        const symmetricKey = await crypto.subtle.generateKey(
          { name: 'AES-GCM', length: 256 },
          true,
          ['encrypt', 'decrypt']
        )

        const encodedPlainText = new TextEncoder().encode(plainText);
        const iv = crypto.getRandomValues(new Uint8Array(12))
        const encryptedData = await crypto.subtle.encrypt(
          { name: 'AES-GCM', iv },
          symmetricKey,
          encodedPlainText
        )

        const exportedSymmetricKey = await crypto.subtle.exportKey('raw', symmetricKey)

        const encryptedSymmetricKey = await crypto.subtle.encrypt(
          { name: 'RSA-OAEP' },
          publicKey,
          exportedSymmetricKey
        )

        const serialized = [
          encodeURIComponent(btoa(String.fromCharCode(...new Uint8Array(iv)))),
          encodeURIComponent(btoa(String.fromCharCode(...new Uint8Array(encryptedData)))),
          encodeURIComponent(btoa(String.fromCharCode(...new Uint8Array(encryptedSymmetricKey))))
        ].join(',')

        return serialized
      }

      function pemToArrayBuffer(pem) {
        const b64 = pem.replace(/-----[^-]+-----/g, '').replace(/\s/g, '')
        const binary = atob(b64)
        const array = new Uint8Array(binary.length)
        for (let i = 0; i < binary.length; i++) {
          array[i] = binary.charCodeAt(i)
        }
        return array.buffer
      }
    </script>
  </body>
</html>
